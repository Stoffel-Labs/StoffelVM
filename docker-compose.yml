# StoffelVM 5-Node MPC Test Environment with Clients
# This docker-compose file sets up a 5-node MPC network with threshold 1
# and 2 clients that provide secret inputs to test distributed VM execution
# including program sync, leader node, and client input provision.
#
# Usage:
#   docker-compose build
#   docker-compose up
#
# To build with NAT traversal support:
#   docker-compose build --build-arg ENABLE_NAT=true
#
# To view logs from a specific party:
#   docker-compose logs -f party0
#
# To run with a different program:
#   STOFFEL_PROGRAM=/app/programs/your_program.stflb docker-compose up
#
# For cross-internet NAT traversal, see docker-compose.nat.yml

services:
  # Party 0 - Leader node (runs bootnode + party 0)
  party0:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party0
    hostname: party0
    environment:
      - STOFFEL_ROLE=leader
      - STOFFEL_PARTY_ID=0
      - STOFFEL_BIND_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/client_mul.stflb
      - STOFFEL_ENTRY=main
      - STOFFEL_EXPECTED_CLIENTS=0,1
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.10
    ports:
      - "9000:9000/tcp"   # Bootnode port (TCP)
      - "9000:9000/udp"   # Bootnode port (UDP/QUIC)
      - "10000:10000/tcp" # Party communication port (TCP)
      - "10000:10000/udp" # Party communication port (UDP/QUIC)
    healthcheck:
      test: ["CMD-SHELL", "netstat -tuln | grep -q ':9000' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Party 1
  party1:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party1
    hostname: party1
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=1
      - STOFFEL_BIND_ADDR=172.28.0.11:9001
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/client_mul.stflb
      - STOFFEL_ENTRY=main
      - STOFFEL_EXPECTED_CLIENTS=0,1
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.11
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9001:9001/tcp"
      - "9001:9001/udp"

  # Party 2
  party2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party2
    hostname: party2
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=2
      - STOFFEL_BIND_ADDR=172.28.0.12:9002
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/client_mul.stflb
      - STOFFEL_ENTRY=main
      - STOFFEL_EXPECTED_CLIENTS=0,1
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.12
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9002:9002/tcp"
      - "9002:9002/udp"

  # Party 3
  party3:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party3
    hostname: party3
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=3
      - STOFFEL_BIND_ADDR=172.28.0.13:9003
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/client_mul.stflb
      - STOFFEL_ENTRY=main
      - STOFFEL_EXPECTED_CLIENTS=0,1
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0x7c852118294e51e653712a81e05800f419141751be58f605c371e15141b007a6
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.13
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9003:9003/tcp"
      - "9003:9003/udp"

  # Party 4
  party4:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party4
    hostname: party4
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=4
      - STOFFEL_BIND_ADDR=172.28.0.14:9004
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/client_mul.stflb
      - STOFFEL_ENTRY=main
      - STOFFEL_EXPECTED_CLIENTS=0,1
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0x47e179ec197488593b187f80a00eb0da91f1b9d0b13f8733639f19c30a34926a
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.14
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9004:9004/tcp"
      - "9004:9004/udp"

  # Client 0 - Provides first input (value: 15)
  client0:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-client0
    hostname: client0
    environment:
      - STOFFEL_ROLE=client
      - STOFFEL_CLIENT_ID=0
      - STOFFEL_INPUTS=15
      - STOFFEL_SERVERS=172.28.0.10:10000,172.28.0.11:9001,172.28.0.12:9002,172.28.0.13:9003,172.28.0.14:9004
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_CLIENT_DELAY=15
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0x8b3a350cf5c34c9194ca85829a2df0ec3153be0318b5e2d3348e872092edffba
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.100
    depends_on:
      party0:
        condition: service_healthy
      party1:
        condition: service_started
      party2:
        condition: service_started
      party3:
        condition: service_started
      party4:
        condition: service_started

  # Client 1 - Provides second input (value: 25)
  client1:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-client1
    hostname: client1
    environment:
      - STOFFEL_ROLE=client
      - STOFFEL_CLIENT_ID=1
      - STOFFEL_INPUTS=25
      - STOFFEL_SERVERS=172.28.0.10:10000,172.28.0.11:9001,172.28.0.12:9002,172.28.0.13:9003,172.28.0.14:9004
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_CLIENT_DELAY=15
      - STOFFEL_ETH_NODE_ADDR=ws://host.docker.internal:8545
      - STOFFEL_WALLET_SK=0x92db14e403b83dfe3df233f83dfa3a0d7096f21ca9b0d6d6b8d88b2b4ec1564e
      - STOFFEL_COORD_ADDR=0x5FbDB2315678afecb367f032d93F642f64180aa3
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.101
    depends_on:
      party0:
        condition: service_healthy
      party1:
        condition: service_started
      party2:
        condition: service_started
      party3:
        condition: service_started
      party4:
        condition: service_started

networks:
  stoffel-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
