# StoffelVM 5-Node MPC Test Environment
# This docker-compose file sets up a 5-node MPC network with threshold 1
# to test distributed VM execution including program sync, leader node,
# and client input provision.
#
# Usage:
#   docker-compose build
#   docker-compose up
#
# To build with NAT traversal support:
#   docker-compose build --build-arg ENABLE_NAT=true
#
# To view logs from a specific party:
#   docker-compose logs -f party0
#
# To run with a different program:
#   STOFFEL_PROGRAM=/app/programs/your_program.stflb docker-compose up
#
# For cross-internet NAT traversal, see docker-compose.nat.yml

services:
  # Party 0 - Leader node (runs bootnode + party 0)
  party0:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party0
    hostname: party0
    environment:
      - STOFFEL_ROLE=leader
      - STOFFEL_PARTY_ID=0
      - STOFFEL_BIND_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/matrix_average_fixed_point.stflb
      - STOFFEL_ENTRY=main
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.10
    ports:
      - "9000:9000/tcp"   # Bootnode port (TCP)
      - "9000:9000/udp"   # Bootnode port (UDP/QUIC)
      - "10000:10000/tcp" # Party communication port (TCP)
      - "10000:10000/udp" # Party communication port (UDP/QUIC)
    healthcheck:
      test: ["CMD-SHELL", "netstat -tuln | grep -q ':9000' || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Party 1
  party1:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party1
    hostname: party1
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=1
      - STOFFEL_BIND_ADDR=172.28.0.11:9001
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/matrix_average_fixed_point.stflb
      - STOFFEL_ENTRY=main
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.11
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9001:9001/tcp"
      - "9001:9001/udp"

  # Party 2
  party2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party2
    hostname: party2
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=2
      - STOFFEL_BIND_ADDR=172.28.0.12:9002
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/matrix_average_fixed_point.stflb
      - STOFFEL_ENTRY=main
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.12
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9002:9002/tcp"
      - "9002:9002/udp"

  # Party 3
  party3:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party3
    hostname: party3
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=3
      - STOFFEL_BIND_ADDR=172.28.0.13:9003
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/matrix_average_fixed_point.stflb
      - STOFFEL_ENTRY=main
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.13
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9003:9003/tcp"
      - "9003:9003/udp"

  # Party 4
  party4:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        ENABLE_NAT: ${ENABLE_NAT:-false}
    container_name: stoffel-party4
    hostname: party4
    environment:
      - STOFFEL_ROLE=party
      - STOFFEL_PARTY_ID=4
      - STOFFEL_BIND_ADDR=172.28.0.14:9004
      - STOFFEL_BOOTSTRAP_ADDR=172.28.0.10:9000
      - STOFFEL_N_PARTIES=5
      - STOFFEL_THRESHOLD=1
      - STOFFEL_PROGRAM=/app/programs/matrix_average_fixed_point.stflb
      - STOFFEL_ENTRY=main
      - RUST_LOG=info
      - RUST_BACKTRACE=1
    networks:
      stoffel-net:
        ipv4_address: 172.28.0.14
    depends_on:
      party0:
        condition: service_healthy
    ports:
      - "9004:9004/tcp"
      - "9004:9004/udp"

networks:
  stoffel-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
